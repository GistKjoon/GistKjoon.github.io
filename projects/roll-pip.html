import React, { useState, useEffect, useRef } from 'react';

function WeeklyGoalApp() {
  // ìƒíƒœ ì •ì˜
  const [goals, setGoals] = useState([]);  // ëª©í‘œ ë¦¬ìŠ¤íŠ¸: {id, text, color, active, createdAt}
  const [records, setRecords] = useState({});  // ì™„ë£Œ ê¸°ë¡: { goalId: [ë‚ ì§œ ë¬¸ìì—´ ëª©ë¡] }
  const [theme, setTheme] = useState('light');  // 'light' ë˜ëŠ” 'dark'
  const [viewMode, setViewMode] = useState('week');  // 'week' (ì£¼ê°„) ë˜ëŠ” 'month' (ì›”ê°„)
  const [currentDate, setCurrentDate] = useState(() => {
    // í˜„ì¬ ì£¼ì˜ ì›”ìš”ì¼ ë‚ ì§œë¡œ ì´ˆê¸°í™”
    const now = new Date();
    const day = now.getDay();              // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ...
    const diff = (day + 6) % 7;           // ì›”ìš”ì¼ ê¸°ì¤€ ìš”ì¼ ì˜¤í”„ì…‹ (ì›”ìš”ì¼->0, ... ì¼ìš”ì¼->6)
    now.setDate(now.getDate() - diff);
    now.setHours(0, 0, 0, 0);
    return now;
  });
  const [editingGoal, setEditingGoal] = useState(null);   // í¸ì§‘ ì¤‘ì¸ ëª©í‘œ (ì—†ìœ¼ë©´ null, ì‹ ê·œ ì¶”ê°€ ì‹œ {id: null, ...})
  const [showSettings, setShowSettings] = useState(false); // ì„¤ì • ëª¨ë‹¬ í‘œì‹œ ì—¬ë¶€

  // ref ì •ì˜
  const nextIdRef = useRef(1);            // ìƒˆë¡œìš´ ëª©í‘œ ID ìƒì„±ìš©
  const fileInputRef = useRef(null);      // íŒŒì¼ ì…ë ¥ ìš”ì†Œ ref (JSON ê°€ì ¸ì˜¤ê¸°)
  const touchStartX = useRef(null);       // í„°ì¹˜ ì‹œì‘ Xì¢Œí‘œ ì €ì¥

  // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  useEffect(() => {
    try {
      const stored = localStorage.getItem('weeklyGoalsData');
      if (stored) {
        const data = JSON.parse(stored);
        if (data.goals && data.records) {
          setGoals(data.goals);
          setRecords(data.records);
          // nextId ê³„ì‚° (ê¸°ì¡´ ëª©í‘œ ì¤‘ ìµœëŒ€ id + 1)
          let maxId = 0;
          data.goals.forEach(g => { if (g.id > maxId) maxId = g.id; });
          nextIdRef.current = maxId + 1;
        }
        if (data.theme) {
          setTheme(data.theme);
        }
      }
    } catch (e) {
      console.error('Failed to load data:', e);
    }
  }, []);

  // ìƒíƒœ ë³€ê²½ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
  useEffect(() => {
    const data = { goals, records, theme };
    try {
      localStorage.setItem('weeklyGoalsData', JSON.stringify(data));
    } catch (e) {
      console.error('Failed to save data:', e);
    }
  }, [goals, records, theme]);

  // ë‹¤í¬/ë¼ì´íŠ¸ í…Œë§ˆ í´ë˜ìŠ¤ HTMLì— ì ìš©
  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [theme]);

  // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (â†/â†’ ì£¼ê°„ ì´ë™, N ìƒˆ ëª©í‘œ ì¶”ê°€)
  useEffect(() => {
    const keyHandler = (e) => {
      const tag = e.target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA') return;  // ì…ë ¥ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        // ì´ì „ ì£¼ ë˜ëŠ” ì´ì „ ë‹¬
        if (viewMode === 'week') {
          setCurrentDate(date => {
            const d = new Date(date);
            d.setDate(d.getDate() - 7);
            return d;
          });
        } else if (viewMode === 'month') {
          setCurrentDate(date => {
            const d = new Date(date);
            d.setDate(1);
            d.setMonth(d.getMonth() - 1);
            return d;
          });
        }
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        // ë‹¤ìŒ ì£¼ ë˜ëŠ” ë‹¤ìŒ ë‹¬
        if (viewMode === 'week') {
          setCurrentDate(date => {
            const d = new Date(date);
            d.setDate(d.getDate() + 7);
            return d;
          });
        } else if (viewMode === 'month') {
          setCurrentDate(date => {
            const d = new Date(date);
            d.setDate(1);
            d.setMonth(d.getMonth() + 1);
            return d;
          });
        }
      } else if (e.key.toLowerCase() === 'n') {
        e.preventDefault();
        openAddGoal();
      }
    };
    window.addEventListener('keydown', keyHandler);
    return () => window.removeEventListener('keydown', keyHandler);
  }, [viewMode]);

  // í„°ì¹˜ ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì²˜ë¦¬ (ëª¨ë°”ì¼ ì£¼ê°„ ë³€ê²½)
  const handleTouchStart = (e) => {
    touchStartX.current = e.touches[0].clientX;
  };
  const handleTouchEnd = (e) => {
    if (touchStartX.current === null) return;
    const endX = e.changedTouches[0].clientX;
    const diffX = touchStartX.current - endX;
    const threshold = 50;
    if (diffX > threshold) {
      // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ ì£¼/ë‹¬
      if (viewMode === 'week') {
        setCurrentDate(date => {
          const d = new Date(date);
          d.setDate(d.getDate() + 7);
          return d;
        });
      } else if (viewMode === 'month') {
        setCurrentDate(date => {
          const d = new Date(date);
          d.setDate(1);
          d.setMonth(d.getMonth() + 1);
          return d;
        });
      }
    } else if (diffX < -threshold) {
      // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ì´ì „ ì£¼/ë‹¬
      if (viewMode === 'week') {
        setCurrentDate(date => {
          const d = new Date(date);
          d.setDate(d.getDate() - 7);
          return d;
        });
      } else if (viewMode === 'month') {
        setCurrentDate(date => {
          const d = new Date(date);
          d.setDate(1);
          d.setMonth(d.getMonth() - 1);
          return d;
        });
      }
    }
    touchStartX.current = null;
  };

  // ë‚ ì§œë¥¼ "YYYY-MM-DD" ë¬¸ìì—´ë¡œ í¬ë§·í•˜ëŠ” ìœ í‹¸ë¦¬í‹°
  const formatDate = (date) => {
    const y = date.getFullYear();
    const m = ('0' + (date.getMonth() + 1)).slice(-2);
    const d = ('0' + date.getDate()).slice(-2);
    return `${y}-${m}-${d}`;
  };

  // ì£¼ê°„ ë‚ ì§œ ë°°ì—´ (ì›”~ì¼) ìƒì„±
  const getWeekDates = (refDate) => {
    const d = new Date(refDate);
    const day = d.getDay();
    const diff = (day + 6) % 7;
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    const week = [];
    for (let i = 0; i < 7; i++) {
      const newD = new Date(d);
      newD.setDate(d.getDate() + i);
      week.push(newD);
    }
    return week;
  };

  // ì›”ê°„ ë‹¬ë ¥ ë‚ ì§œ ë°°ì—´ ìƒì„± (í‘œì‹œìš© ì…€ í¬í•¨)
  const getMonthDays = (refDate) => {
    const year = refDate.getFullYear();
    const month = refDate.getMonth();
    const first = new Date(year, month, 1);
    const last = new Date(year, month + 1, 0);
    const daysInMonth = last.getDate();
    // ì›”ê°„ ë‹¬ë ¥ ì‹œì‘ì„ í•´ë‹¹ ì›” ì²«ì§¸ì£¼ì˜ ì›”ìš”ì¼ë¡œ ë§ì¶¤
    const startOffset = (first.getDay() + 6) % 7;  // 1ì¼ì˜ ìš”ì¼ (ì›”ìš”ì¼ ê¸°ì¤€ ì˜¤í”„ì…‹)
    const totalCells = Math.ceil((startOffset + daysInMonth) / 7) * 7;
    const startDate = new Date(first);
    startDate.setDate(first.getDate() - startOffset);
    const grid = [];
    for (let i = 0; i < totalCells; i++) {
      const cur = new Date(startDate);
      cur.setDate(startDate.getDate() + i);
      grid.push(cur);
    }
    return grid;
  };

  // í…Œë§ˆ í† ê¸€ (ë‹¤í¬/ë¼ì´íŠ¸)
  const toggleTheme = () => {
    setTheme(prev => (prev === 'dark' ? 'light' : 'dark'));
  };

  // ëª©í‘œ ì¶”ê°€/í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
  const openAddGoal = () => {
    setEditingGoal({ id: null, text: '', color: 'gray', active: true });
  };
  const openEditGoal = (goal) => {
    setEditingGoal({ ...goal });
  };
  const closeModal = () => {
    setEditingGoal(null);
    setShowSettings(false);
  };

  // ëª©í‘œ ì €ì¥ (ì¶”ê°€ ë˜ëŠ” ìˆ˜ì •)
  const saveGoal = () => {
    if (!editingGoal) return;
    const { id, text, color, active } = editingGoal;
    if (text.trim() === '') {
      alert('ëª©í‘œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (id == null) {
      // ìƒˆ ëª©í‘œ ì¶”ê°€
      const newGoal = {
        id: nextIdRef.current,
        text: text.trim(),
        color,
        active: true,
        createdAt: formatDate(new Date())
      };
      nextIdRef.current += 1;
      setGoals(prev => [...prev, newGoal]);
      // ì™„ë£Œ ê¸°ë¡ ì´ˆê¸°í™”
      setRecords(prev => ({ ...prev, [newGoal.id]: [] }));
    } else {
      // ê¸°ì¡´ ëª©í‘œ í¸ì§‘ ì €ì¥
      setGoals(prev => prev.map(g => (g.id === id ? { ...g, text: text.trim(), color, active } : g)));
    }
    setEditingGoal(null);
  };

  // ëª©í‘œ ì‚­ì œ
  const deleteGoal = () => {
    if (!editingGoal || editingGoal.id == null) {
      setEditingGoal(null);
      return;
    }
    if (!window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }
    const goalId = editingGoal.id;
    setGoals(prev => prev.filter(g => g.id !== goalId));
    setRecords(prev => {
      const newRec = { ...prev };
      delete newRec[goalId];
      return newRec;
    });
    setEditingGoal(null);
  };

  // ëª©í‘œ í™œì„±/ë¹„í™œì„± í† ê¸€
  const toggleGoalActive = (goalId) => {
    setGoals(prev => prev.map(g => (g.id === goalId ? { ...g, active: !g.active } : g)));
  };

  // ëª©í‘œ ì™„ë£Œ ì²´í¬ í† ê¸€ (ì²´í¬ë°•ìŠ¤)
  const toggleComplete = (goalId, dateStr) => {
    setRecords(prev => {
      const goalRecs = prev[goalId] || [];
      let newRecords = [...goalRecs];
      if (newRecords.includes(dateStr)) {
        // ì²´í¬ í•´ì œ
        newRecords = newRecords.filter(d => d !== dateStr);
      } else {
        // ì²´í¬
        newRecords.push(dateStr);
      }
      return { ...prev, [goalId]: newRecords };
    });
    // í–…í‹± í”¼ë“œë°± (ì§€ì› ê¸°ê¸°ì—ì„œë§Œ)
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  };

  // JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const importData = (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    file.text().then(jsonStr => {
      try {
        const data = JSON.parse(jsonStr);
        if (data.goals && data.records) {
          setGoals(data.goals);
          setRecords(data.records);
          let maxId = 0;
          data.goals.forEach(g => { if (g.id > maxId) maxId = g.id; });
          nextIdRef.current = maxId + 1;
        }
        if (data.theme) {
          setTheme(data.theme);
        }
        alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
      } catch (err) {
        alert('JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    });
    e.target.value = '';  // ë™ì¼ íŒŒì¼ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ì´ˆê¸°í™”
  };

  // JSON ë°ì´í„° ë‚´ë³´ë‚´ê¸°
  const exportData = () => {
    const data = { goals, records, theme };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'weekly_goals_backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // íŒŒìƒ ë°ì´í„° ê³„ì‚°
  const activeGoals = goals.filter(g => g.active);
  const inactiveGoals = goals.filter(g => !g.active);

  const weekDates = getWeekDates(currentDate);
  const weekStart = weekDates[0];
  const weekEnd = weekDates[6];
  const weekRangeStr = 
    `${weekStart.getFullYear()}ë…„ ${weekStart.getMonth() + 1}ì›” ${weekStart.getDate()}ì¼ ~ ` +
    `${weekEnd.getMonth() + 1}ì›” ${weekEnd.getDate()}ì¼`;

  const monthDays = getMonthDays(currentDate);
  const monthYearStr = `${currentDate.getFullYear()}ë…„ ${currentDate.getMonth() + 1}ì›”`;

  // ì£¼ê°„ ì™„ë£Œ í†µê³„ ê³„ì‚°
  let totalTasksWeek = 0;
  let completedTasksWeek = 0;
  const dailyCompleted = {};
  const dailyTotal = {};
  activeGoals.forEach(goal => {
    weekDates.forEach(day => {
      const dayStr = formatDate(day);
      // í•´ë‹¹ ë‚ ì§œì— ëª©í‘œê°€ ì¡´ì¬í–ˆëŠ”ì§€ í™•ì¸ (ìƒì„± ì´ì „ì´ë©´ ì œì™¸)
      if (goal.createdAt && dayStr < goal.createdAt) return;
      dailyTotal[dayStr] = (dailyTotal[dayStr] || 0) + 1;
      totalTasksWeek += 1;
      const done = records[goal.id]?.includes(dayStr);
      if (done) {
        dailyCompleted[dayStr] = (dailyCompleted[dayStr] || 0) + 1;
        completedTasksWeek += 1;
      } else {
        dailyCompleted[dayStr] = dailyCompleted[dayStr] || 0;
      }
    });
  });
  const completionRate = totalTasksWeek > 0 ? Math.floor((completedTasksWeek * 100) / totalTasksWeek) : 0;

  // ëª©í‘œ ìŠ¤íŠ¸ë¦­ ê³„ì‚° (í˜„ì¬ ì—°ì†ì¼ ë° ìµœê³  ê¸°ë¡)
  let currentStreak = 0;
  let bestStreak = 0;
  if (activeGoals.length > 0) {
    // í˜„ì¬ í™œì„± ëª©í‘œë“¤ì˜ ì¶”ì  ì‹œì‘ì¼ (ê°€ì¥ ì˜¤ë˜ëœ ìƒì„±ì¼)
    let startTrackingDate = new Date();
    activeGoals.forEach(goal => {
      const created = goal.createdAt ? new Date(goal.createdAt) : new Date();
      if (created < startTrackingDate) {
        startTrackingDate = created;
      }
    });
    const todayStr = formatDate(new Date());
    let streakCount = 0;
    for (let d = new Date(startTrackingDate); formatDate(d) <= todayStr; d.setDate(d.getDate() + 1)) {
      const dayStr = formatDate(d);
      // í•´ë‹¹ ì¼ìì— ì¡´ì¬í•˜ëŠ” í™œì„± ëª©í‘œë“¤
      const tasksForDay = activeGoals.filter(g => !g.createdAt || dayStr >= g.createdAt);
      if (tasksForDay.length === 0) {
        // í•  ëª©í‘œê°€ ì—†ì—ˆë˜ ë‚ ì€ ìŠ¤íŠ¸ë¦­ ê³„ì‚°ì—ì„œ ì œì™¸
        continue;
      }
      const allDone = tasksForDay.every(g => records[g.id]?.includes(dayStr));
      if (allDone) {
        streakCount += 1;
      } else {
        if (streakCount > bestStreak) bestStreak = streakCount;
        streakCount = 0;
      }
    }
    currentStreak = streakCount;
    if (streakCount > bestStreak) {
      bestStreak = streakCount;
    }
  }

  // ì²´í¬ë°•ìŠ¤ ìƒ‰ìƒ í´ë˜ìŠ¤ (Tailwind accent-*)
  const accentClass = {
    red: 'accent-red-500',
    orange: 'accent-orange-500',
    yellow: 'accent-yellow-500',
    green: 'accent-green-500',
    blue: 'accent-blue-500',
    purple: 'accent-purple-500',
    gray: 'accent-gray-500'
  };
  // ìƒ‰ìƒ ì„ íƒ ë²„íŠ¼ í´ë˜ìŠ¤ (ë°°ê²½ìƒ‰)
  const colorList = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'gray'];
  const bgClasses = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-gray-500'];

  return (
    <div className={theme === 'dark' ? 'dark' : ''} onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}>
      <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300 flex flex-col">
        {/* í—¤ë” */}
        <header className="flex items-center justify-between p-4 border-b border-gray-300 dark:border-gray-700">
          {/* ë·° ëª¨ë“œ íƒ­ (ì£¼ê°„/ì›”ê°„) */}
          <div className="flex items-center space-x-2">
            <button 
              className={`px-3 py-1 rounded ${viewMode === 'week' ? 'bg-gray-300 dark:bg-gray-700 font-bold' : 'bg-gray-200 dark:bg-gray-800'}`}
              onClick={() => setViewMode('week')}
            >
              ì£¼ê°„
            </button>
            <button 
              className={`px-3 py-1 rounded ${viewMode === 'month' ? 'bg-gray-300 dark:bg-gray-700 font-bold' : 'bg-gray-200 dark:bg-gray-800'}`}
              onClick={() => setViewMode('month')}
            >
              ì›”ê°„
            </button>
          </div>
          {/* í…Œë§ˆ í† ê¸€ & ì„¤ì • & ë¡œê³  */}
          <div className="flex items-center space-x-3">
            <button onClick={toggleTheme} className="text-xl">
              {theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸'}
            </button>
            <button onClick={() => setShowSettings(true)} className="text-xl">âš™ï¸</button>
          </div>
        </header>

        {/* ë©”ì¸ ì½˜í…ì¸  */}
        <main className="flex-1 p-4 overflow-auto">
          {viewMode === 'week' ? (
            // ì£¼ê°„ í™”ë©´
            <div>
              {/* ì£¼ê°„ ë‚´ë¹„ê²Œì´ì…˜ (ì´ì „/ë‹¤ìŒ ì£¼) */}
              <div className="flex items-center justify-center mb-2 space-x-4">
                <button onClick={() => setCurrentDate(d => { const nd = new Date(d); nd.setDate(d.getDate() - 7); return nd; })} className="px-2">â—€</button>
                <span className="font-medium">{weekRangeStr}</span>
                <button onClick={() => setCurrentDate(d => { const nd = new Date(d); nd.setDate(d.getDate() + 7); return nd; })} className="px-2">â–¶</button>
              </div>
              {/* ì£¼ê°„ ëª©í‘œ ë³´ë“œ */}
              <div className="grid grid-cols-1 md:grid-cols-7 gap-4">
                {weekDates.map(date => {
                  const dayLabel = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][date.getDay()];
                  const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;
                  const dateStr = formatDate(date);
                  return (
                    <div key={dateStr} className="border border-gray-300 dark:border-gray-700 rounded p-2 flex flex-col">
                      <div className="mb-1 font-semibold">
                        {dayLabel}{' '}
                        <span className="text-sm text-gray-600 dark:text-gray-400">{monthDay}</span>
                      </div>
                      {activeGoals.map(goal => {
                        // ëª©í‘œ ìƒì„± ì´ì „ ë‚ ì§œëŠ” í‘œì‹œ ê±´ë„ˆëœ€
                        if (goal.createdAt && dateStr < goal.createdAt) return null;
                        const checked = records[goal.id]?.includes(dateStr) || false;
                        return (
                          <label key={goal.id} className="flex items-center mb-1">
                            <input
                              type="checkbox"
                              checked={checked}
                              onChange={() => toggleComplete(goal.id, dateStr)}
                              className={`mr-2 ${accentClass[goal.color] || 'accent-blue-500'} rounded`}
                            />
                            <span className="flex-1">{goal.text}</span>
                          </label>
                        );
                      })}
                    </div>
                  );
                })}
              </div>
              {/* ì£¼ê°„ í†µê³„ ì„¹ì…˜ */}
              <div className="mt-6 p-4 bg-gray-200 dark:bg-gray-800 rounded">
                {/* ì „ì²´ ì™„ë£Œìœ¨ */}
                <div className="mb-2 font-semibold">ì£¼ê°„ ì™„ë£Œìœ¨: {completionRate}%</div>
                <div className="w-full bg-gray-300 dark:bg-gray-700 rounded-full h-3 mb-4">
                  <div className="bg-green-500 h-3 rounded-full" style={{ width: `${completionRate}%` }} />
                </div>
                {/* ì¼ë³„ ì™„ë£Œ ë°”ì°¨íŠ¸ */}
                <div className="mb-4">
                  <div className="flex justify-between items-end">
                    {weekDates.map(date => {
                      const dateStr = formatDate(date);
                      const doneCount = dailyCompleted[dateStr] || 0;
                      const totCount = dailyTotal[dateStr] || 0;
                      const percent = totCount ? doneCount / totCount : 0;
                      const barHeight = Math.round(percent * 50) || 2;  // ìµœëŒ€ 50px ë†’ì´
                      const label = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'][(date.getDay() + 6) % 7];
                      return (
                        <div key={dateStr} className="flex flex-col items-center" style={{ width: '14%' }}>
                          <div className="bg-blue-500 opacity-80" style={{ height: `${barHeight}px`, width: '8px' }} />
                          <div className="mt-1 text-xs">{label}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
                {/* ìŠ¤íŠ¸ë¦­ ì •ë³´ */}
                <div className="text-sm">
                  í˜„ì¬ ì—°ì† ë‹¬ì„±: {currentStreak}ì¼, ìµœê³  ì—°ì†: {bestStreak}ì¼
                </div>
              </div>
              {/* ë¹„í™œì„±í™”ëœ ëª©í‘œ ëª©ë¡ */}
              {inactiveGoals.length > 0 && (
                <div className="mt-6 p-4 bg-gray-100 dark:bg-gray-800 rounded">
                  <div className="font-semibold mb-2">ë¹„í™œì„±í™”ëœ ëª©í‘œ</div>
                  {inactiveGoals.map(goal => (
                    <div key={goal.id} className="flex items-center justify-between text-sm mb-1">
                      <span className="line-through opacity-70">{goal.text}</span>
                      <button onClick={() => toggleGoalActive(goal.id)} className="text-blue-500 hover:underline">í™œì„±í™”</button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          ) : (
            // ì›”ê°„ í™”ë©´
            <div>
              {/* ì›”ê°„ ë‚´ë¹„ê²Œì´ì…˜ (ì´ì „/ë‹¤ìŒ ë‹¬) */}
              <div className="flex items-center justify-center mb-2 space-x-4">
                <button onClick={() => setCurrentDate(d => { const nd = new Date(d); nd.setDate(1); nd.setMonth(d.getMonth() - 1); return nd; })} className="px-2">â—€</button>
                <span className="font-medium">{monthYearStr}</span>
                <button onClick={() => setCurrentDate(d => { const nd = new Date(d); nd.setDate(1); nd.setMonth(d.getMonth() + 1); return nd; })} className="px-2">â–¶</button>
              </div>
              {/* ì›”ê°„ ë‹¬ë ¥ */}
              <div className="grid grid-cols-7 gap-1 text-center text-sm">
                {/* ìš”ì¼ í—¤ë” */}
                {['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].map((d, i) => (
                  <div key={i} className="font-semibold mb-1">{d}</div>
                ))}
                {/* ë‚ ì§œ ì…€ */}
                {monthDays.map((date, idx) => {
                  const dateStr = formatDate(date);
                  const inMonth = (date.getMonth() === currentDate.getMonth());
                  // ì™„ë£Œ ê°œìˆ˜/ì „ì²´ ê°œìˆ˜ ê³„ì‚°
                  let dayTotal = 0;
                  let dayDone = 0;
                  activeGoals.forEach(goal => {
                    if (goal.createdAt && dateStr < goal.createdAt) return;
                    const todayStr = formatDate(new Date());
                    if (dateStr > todayStr) return;  // ì˜¤ëŠ˜ ì´í›„ ë‚ ì§œëŠ” ê³„ì‚° ìƒëµ
                    dayTotal += 1;
                    if (records[goal.id]?.includes(dateStr)) {
                      dayDone += 1;
                    }
                  });
                  const percent = dayTotal ? dayDone / dayTotal : 0;
                  // ì…€ ë°°ê²½ ìƒ‰ìƒ (ë‹¬ì„±ë¥ ì— ë”°ë¼)
                  let cellClass = '';
                  if (!inMonth) {
                    cellClass = 'bg-gray-200 dark:bg-gray-700';
                  } else if (percent === 1) {
                    cellClass = 'bg-green-500';
                  } else if (percent >= 0.5) {
                    cellClass = 'bg-green-300';
                  } else if (percent > 0) {
                    cellClass = 'bg-yellow-300';
                  } else {
                    cellClass = 'bg-gray-300 dark:bg-gray-600';
                  }
                  return (
                    <div
                      key={idx}
                      className={`aspect-square flex items-center justify-center ${cellClass} ${inMonth ? '' : 'opacity-50'}`}
                      onClick={() => {
                        if (inMonth) {
                          setCurrentDate(date);
                          setViewMode('week');
                        }
                      }}
                    >
                      <span>{date.getDate()}</span>
                    </div>
                  );
                })}
              </div>
              {/* ìŠ¤íŠ¸ë¦­ ì •ë³´ (ì›”ê°„ í™”ë©´ í•˜ë‹¨) */}
              <div className="mt-4 text-sm text-center">
                í˜„ì¬ ì—°ì† ë‹¬ì„±: {currentStreak}ì¼, ìµœê³  ì—°ì†: {bestStreak}ì¼
              </div>
            </div>
          )}
        </main>

        {/* í•˜ë‹¨ ëª¨ë°”ì¼ ë‚´ë¹„ê²Œì´ì…˜ */}
        <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-300 dark:border-gray-700">
          <div className="flex justify-around text-sm text-gray-800 dark:text-gray-100">
            <button onClick={() => setViewMode('week')} className="py-2 flex flex-col items-center">
              <span className="text-xl">ğŸ </span>
              <span>ì£¼ê°„</span>
            </button>
            <button onClick={openAddGoal} className="py-2 flex flex-col items-center">
              <span className="text-xl">â•</span>
              <span>ì¶”ê°€</span>
            </button>
            <button onClick={() => setViewMode('month')} className="py-2 flex flex-col items-center">
              <span className="text-xl">ğŸ—“ï¸</span>
              <span>ì›”ê°„</span>
            </button>
            <button onClick={() => setShowSettings(true)} className="py-2 flex flex-col items-center">
              <span className="text-xl">âš™ï¸</span>
              <span>ì„¤ì •</span>
            </button>
          </div>
        </nav>

        {/* ëª©í‘œ ì¶”ê°€/í¸ì§‘ ëª¨ë‹¬ */}
        {editingGoal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10">
            <div className="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 p-6 rounded shadow max-w-xs w-full">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold">
                  {editingGoal.id == null ? 'ëª©í‘œ ì¶”ê°€' : 'ëª©í‘œ ìˆ˜ì •'}
                </h2>
                <button onClick={closeModal} className="text-2xl font-bold">&times;</button>
              </div>
              <div className="mb-3">
                <input
                  type="text"
                  className="w-full p-2 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"
                  placeholder="ëª©í‘œ ì´ë¦„"
                  value={editingGoal.text}
                  onChange={(e) => setEditingGoal({ ...editingGoal, text: e.target.value })}
                />
              </div>
              <div className="mb-3">
                <label className="block mb-1">ìƒ‰ìƒ ë¼ë²¨:</label>
                <div className="flex space-x-2">
                  {colorList.map((col, idx) => (
                    <button
                      key={col}
                      className={`w-6 h-6 rounded-full ${bgClasses[idx]} ${editingGoal.color === col ? '' : 'opacity-50'}`}
                      onClick={() => setEditingGoal({ ...editingGoal, color: col })}
                    />
                  ))}
                </div>
              </div>
              <div className="mb-4">
                <label className="inline-flex items-center">
                  <input
                    type="checkbox"
                    checked={editingGoal.active}
                    onChange={(e) => setEditingGoal({ ...editingGoal, active: e.target.checked })}
                    className="mr-2"
                  />
                  í™œì„± ìƒíƒœ
                </label>
              </div>
              <div className="flex justify-between">
                {editingGoal.id != null ? (
                  <button onClick={deleteGoal} className="text-red-500">ì‚­ì œ</button>
                ) : <span></span>}
                <div className="space-x-2">
                  <button onClick={closeModal} className="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded">ì·¨ì†Œ</button>
                  <button onClick={saveGoal} className="px-3 py-1 bg-blue-500 text-white rounded">
                    {editingGoal.id == null ? 'ì¶”ê°€' : 'ì €ì¥'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ì„¤ì • ëª¨ë‹¬ */}
        {showSettings && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10">
            <div className="bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 p-6 rounded shadow max-w-xs w-full">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-semibold">ì„¤ì •</h2>
                <button onClick={closeModal} className="text-2xl font-bold">&times;</button>
              </div>
              <div className="mb-4">
                <label className="mr-2">í…Œë§ˆ:</label>
                <button onClick={toggleTheme} className="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700">
                  {theme === 'dark' ? 'ë¼ì´íŠ¸ ëª¨ë“œë¡œ' : 'ë‹¤í¬ ëª¨ë“œë¡œ'}
                </button>
              </div>
              <div className="mb-4">
                <div className="mb-2">ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°:</div>
                <div className="flex space-x-2">
                  <button onClick={exportData} className="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded">ë‚´ë³´ë‚´ê¸°</button>
                  <button onClick={() => fileInputRef.current.click()} className="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded">ê°€ì ¸ì˜¤ê¸°</button>
                  <input
                    type="file"
                    accept="application/json"
                    ref={fileInputRef}
                    onChange={importData}
                    style={{ display: 'none' }}
                  />
                </div>
              </div>
              <div className="text-xs text-gray-600 dark:text-gray-400">
                â€» ê°€ì ¸ì˜¤ê¸°ë¥¼ í•˜ë©´ í˜„ì¬ ë°ì´í„°ê°€ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

export default WeeklyGoalApp;
